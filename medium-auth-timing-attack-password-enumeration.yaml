id: medium-auth-timing-attack-password-enumeration

info:
  name: Timing Attack Password Enumeration
  author: elite-red-team
  severity: medium
  description: |
    Detects timing attack vulnerabilities in password enumeration where response
    times differ between valid and invalid usernames, allowing attackers to
    enumerate valid accounts through timing analysis.
  reference:
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Username_Enumeration_and_Guessable_User_Account
    - https://portswigger.net/web-security/authentication/password-based/lab-username-enumeration-via-response-timing
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:L/I:N/A:N
    cvss-score: 3.7
    cwe-id: CWE-208
  metadata:
    verified: true
    max-request: 15
  tags: timing-attack,password-enumeration,user-enumeration,response-timing,red-team

variables:
  valid_usernames: ["admin", "administrator", "root", "test", "user"]
  invalid_usernames: ["nonexistent", "fakuser", "invaliduser", "notreal", "dummy"]
  long_password: "ThisIsAVeryLongPasswordThatShouldTakeMoreTimeToProcessIfTheUserExists1234567890"

http:
  - raw:
      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","password":"{{long_password}}"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"nonexistent","password":"{{long_password}}"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"administrator","password":"{{long_password}}"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"fakuser","password":"{{long_password}}"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"root","password":"{{long_password}}"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"invaliduser","password":"{{long_password}}"}

      - |
        POST /login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 125
        Connection: close
        
        username=test&password={{long_password}}

      - |
        POST /login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 125
        Connection: close
        
        username=notreal&password={{long_password}}

      - |
        POST /api/password/reset HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"email":"admin@example.com"}

      - |
        POST /api/password/reset HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"email":"nonexistent@example.com"}

      - |
        POST /api/users/check HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 35
        Connection: close
        
        {"username":"user"}

      - |
        POST /api/users/check HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 35
        Connection: close
        
        {"username":"dummy"}

      - |
        POST /api/auth/validate HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 65
        Connection: close
        
        {"username":"admin","token":"invalid_token_123"}

      - |
        POST /api/auth/validate HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 65
        Connection: close
        
        {"username":"nonexistent","token":"invalid_token_123"}

      - |
        POST /api/auth/login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"username":"admin","password":"short"}

    matchers-condition: or
    matchers:
      - type: dsl
        name: timing-difference-login-api
        dsl:
          - 'status_code_1 == 401 && status_code_2 == 401'
          - 'contains(body_1, "invalid") && contains(body_2, "invalid")'
          - 'response_time_1 > response_time_2 + 200'
        condition: and

      - type: dsl
        name: timing-difference-admin-vs-fake
        dsl:
          - 'status_code_3 == 401 && status_code_4 == 401'
          - 'contains(body_3, "password") && contains(body_4, "user")'
          - 'response_time_3 > response_time_4 + 150'
        condition: and

      - type: dsl
        name: timing-difference-root-vs-invalid
        dsl:
          - 'status_code_5 == 401 && status_code_6 == 401'
          - 'response_time_5 > response_time_6 + 100'
        condition: and

      - type: dsl
        name: timing-difference-form-login
        dsl:
          - 'status_code_7 == 401 && status_code_8 == 401'
          - 'response_time_7 > response_time_8 + 150'
        condition: and

      - type: dsl
        name: timing-difference-password-reset
        dsl:
          - 'status_code_9 == 200 && status_code_10 == 200'
          - 'contains(body_9, "sent") && contains(body_10, "sent")'
          - 'response_time_9 > response_time_10 + 100'
        condition: and

      - type: dsl
        name: timing-difference-user-check
        dsl:
          - 'status_code_11 == 200 && status_code_12 == 200'
          - 'response_time_11 > response_time_12 + 100'
        condition: and

      - type: dsl
        name: timing-difference-token-validation
        dsl:
          - 'status_code_13 == 401 && status_code_14 == 401'
          - 'response_time_13 > response_time_14 + 100'
        condition: and

      - type: word
        name: different-error-messages
        part: body
        words:
          - "user not found"
          - "invalid username"
          - "account does not exist"
          - "user does not exist"
        condition: or

      - type: dsl
        name: consistent-timing-short-password
        dsl:
          - 'status_code_15 == 401'
          - 'response_time_15 < response_time_1 - 100'
        condition: and

    extractors:
      - type: regex
        name: error-messages
        part: body
        group: 1
        regex:
          - '"message":\s*"([^"]+)"'
          - '"error":\s*"([^"]+)"'
          - '"status":\s*"([^"]+)"'

      - type: regex
        name: response-indicators
        part: body
        group: 1
        regex:
          - '"username":\s*"([^"]+)"'
          - '"user_exists":\s*(true|false)'
          - '"valid":\s*(true|false)'

      - type: kval
        kval:
          - response_time_1
          - response_time_2
          - response_time_3
          - response_time_4
          - response_time_5
          - response_time_6
          - response_time_7
          - response_time_8
          - response_time_9
          - response_time_10
          - response_time_11
          - response_time_12
          - response_time_13
          - response_time_14
          - response_time_15

      - type: kval
        kval:
          - status_code_1
          - status_code_2
          - status_code_3
          - status_code_4
          - status_code_5
          - status_code_6
          - status_code_7
          - status_code_8
          - status_code_9
          - status_code_10
          - status_code_11
          - status_code_12
          - status_code_13
          - status_code_14
          - status_code_15