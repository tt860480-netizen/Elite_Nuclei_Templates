id: medium-config-http-only-cookie-flag-missing

info:
  name: HTTP Only Cookie Flag Missing Detection
  author: elite-red-team
  severity: medium
  description: |
    Detects session and authentication cookies without the HttpOnly flag that can be
    accessed via JavaScript. This elite template identifies cookies vulnerable to
    XSS attacks and client-side script access across various web frameworks.
  reference:
    - https://owasp.org/www-community/HttpOnly
    - https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies
    - https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N
    cvss-score: 6.1
    cwe-id: CWE-1004
  metadata:
    verified: true
    max-request: 7
  tags: config,cookie,httponly,session,xss,javascript,medium

http:
  # Test main application pages for session cookies
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/login"
      - "{{BaseURL}}/dashboard"
      - "{{BaseURL}}/profile"
      - "{{BaseURL}}/admin"
      - "{{BaseURL}}/panel"
      - "{{BaseURL}}/console"
      - "{{BaseURL}}/management"
      - "{{BaseURL}}/account"
      - "{{BaseURL}}/settings"
      - "{{BaseURL}}/home"
      - "{{BaseURL}}/index"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      Accept-Language: "en-US,en;q=0.5"
      Connection: "keep-alive"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 301
          - 302

      # Session cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(session|sess|jsession|phpsession|asp\\.net_sessionid|connect\\.sid|laravel_session|django_session|rails_session|express_session|passport|auth|token|login|user|account|remember|persistent)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(SESSIONID|JSESSIONID|PHPSESSID|ASP\\.NET_SessionId|connect\\.sid|laravel_session|django_session|rails_session|express_session|passport|auth|token|login|user|account|remember|persistent)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

      # Ensure it's an interactive application with potential XSS risk
      - type: regex
        part: body
        regex:
          - "(?i)<(script|form|input|button)"
          - "(?i)(login|signin|signup|register|dashboard|profile|admin|account|settings)"
          - "(?i)(javascript|jquery|angular|react|vue|ember)"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:session|sess|jsession|phpsession|asp\\.net_sessionid|connect\\.sid|laravel_session|django_session|rails_session|express_session|passport|auth|token|login|user|account|remember|persistent)[^;\\r\\n]*)"

      - type: kval
        kval:
          - set_cookie
          - server
          - x_powered_by
        part: header

  # Test login endpoints for authentication cookies
  - method: POST
    path:
      - "{{BaseURL}}/login"
      - "{{BaseURL}}/auth/login"
      - "{{BaseURL}}/api/login"
      - "{{BaseURL}}/api/auth/login"
      - "{{BaseURL}}/signin"
      - "{{BaseURL}}/authenticate"
      - "{{BaseURL}}/user/login"
      - "{{BaseURL}}/admin/login"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Content-Type: "application/x-www-form-urlencoded"
      Accept: "text/html,application/json,*/*"

    body: "username=test&password=test&email=test@example.com&login=test"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302
          - 400
          - 401
          - 403
          - 422

      # Authentication cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(session|sess|jsession|phpsession|asp\\.net_sessionid|connect\\.sid|laravel_session|django_session|rails_session|express_session|passport|auth|token|login|user|account|remember|persistent|access_token|refresh_token|jwt|bearer)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:session|sess|jsession|phpsession|asp\\.net_sessionid|connect\\.sid|laravel_session|django_session|rails_session|express_session|passport|auth|token|login|user|account|remember|persistent|access_token|refresh_token|jwt|bearer)[^;\\r\\n]*)"

  # Test for framework-specific session cookies
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/index.php"
      - "{{BaseURL}}/index.jsp"
      - "{{BaseURL}}/index.aspx"
      - "{{BaseURL}}/index.py"
      - "{{BaseURL}}/index.rb"
      - "{{BaseURL}}/app.js"
      - "{{BaseURL}}/main.js"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,*/*"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      # Framework-specific cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          # PHP
          - "(?i)set-cookie:\\s*PHPSESSID=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*laravel_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*symfony=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*codeigniter=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*cakephp=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*zend=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
          # Java
          - "(?i)set-cookie:\\s*JSESSIONID=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*spring_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*struts=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*hibernate=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
          # .NET
          - "(?i)set-cookie:\\s*ASP\\.NET_SessionId=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*\\.ASPXAUTH=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*\\.ASPXROLES=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
          # Node.js
          - "(?i)set-cookie:\\s*connect\\.sid=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*express_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*koa\\.sess=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*next-auth=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
          # Python
          - "(?i)set-cookie:\\s*django_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*flask_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*pyramid_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*tornado_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
          # Ruby
          - "(?i)set-cookie:\\s*rails_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*sinatra_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          - "(?i)set-cookie:\\s*rack_session=[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
          
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*((?:PHPSESSID|laravel_session|symfony|codeigniter|cakephp|zend|JSESSIONID|spring_session|struts|hibernate|ASP\\.NET_SessionId|\\.ASPXAUTH|\\.ASPXROLES|connect\\.sid|express_session|koa\\.sess|next-auth|django_session|flask_session|pyramid_session|tornado_session|rails_session|sinatra_session|rack_session)=[^;\\r\\n]*)"

  # Test API endpoints for token cookies
  - method: GET
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/api/user"
      - "{{BaseURL}}/api/profile"
      - "{{BaseURL}}/api/dashboard"
      - "{{BaseURL}}/api/admin"
      - "{{BaseURL}}/api/auth"
      - "{{BaseURL}}/api/token"
      - "{{BaseURL}}/api/session"
      - "{{BaseURL}}/rest/api"
      - "{{BaseURL}}/graphql"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "application/json,text/html,*/*"
      Authorization: "Bearer test-token"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 401
          - 403

      # API cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(api|token|access|refresh|bearer|jwt|oauth|auth|session|csrf|xsrf|api_key|access_token|refresh_token|id_token)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

      # API response indicators
      - type: word
        part: header
        words:
          - "application/json"
          - "application/xml"
          - "text/json"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:api|token|access|refresh|bearer|jwt|oauth|auth|session|csrf|xsrf|api_key|access_token|refresh_token|id_token)[^;\\r\\n]*)"

  # Test for OAuth and SSO cookies
  - method: GET
    path:
      - "{{BaseURL}}/oauth/authorize"
      - "{{BaseURL}}/oauth/callback"
      - "{{BaseURL}}/auth/callback"
      - "{{BaseURL}}/sso/callback"
      - "{{BaseURL}}/saml/callback"
      - "{{BaseURL}}/openid/callback"
      - "{{BaseURL}}/auth/google"
      - "{{BaseURL}}/auth/facebook"
      - "{{BaseURL}}/auth/github"
      - "{{BaseURL}}/auth/microsoft"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,*/*"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302
          - 400
          - 401

      # OAuth/SSO cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(oauth|sso|saml|openid|oidc|jwt|bearer|access_token|refresh_token|id_token|state|nonce|code|pkce|google|facebook|github|microsoft|twitter|linkedin)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:oauth|sso|saml|openid|oidc|jwt|bearer|access_token|refresh_token|id_token|state|nonce|code|pkce|google|facebook|github|microsoft|twitter|linkedin)[^;\\r\\n]*)"

  # Test for CMS and admin interface cookies
  - method: GET
    path:
      - "{{BaseURL}}/admin"
      - "{{BaseURL}}/admin/login"
      - "{{BaseURL}}/administrator"
      - "{{BaseURL}}/wp-admin"
      - "{{BaseURL}}/wp-login.php"
      - "{{BaseURL}}/phpmyadmin"
      - "{{BaseURL}}/adminer"
      - "{{BaseURL}}/manager"
      - "{{BaseURL}}/control"
      - "{{BaseURL}}/cpanel"
      - "{{BaseURL}}/drupal"
      - "{{BaseURL}}/joomla"
      - "{{BaseURL}}/magento"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,*/*"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302
          - 401
          - 403

      # CMS/Admin interface cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(admin|administrator|wp|wordpress|phpmyadmin|adminer|manager|control|cpanel|plesk|webmin|directadmin|drupal|joomla|magento|prestashop|opencart|woocommerce)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

      # Admin interface indicators
      - type: regex
        part: body
        regex:
          - "(?i)(admin|administrator|management|control|panel|dashboard)"
          - "(?i)(wordpress|drupal|joomla|magento|prestashop|opencart)"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:admin|administrator|wp|wordpress|phpmyadmin|adminer|manager|control|cpanel|plesk|webmin|directadmin|drupal|joomla|magento|prestashop|opencart|woocommerce)[^;\\r\\n]*)"

  # Test for e-commerce and payment cookies
  - method: GET
    path:
      - "{{BaseURL}}/cart"
      - "{{BaseURL}}/checkout"
      - "{{BaseURL}}/payment"
      - "{{BaseURL}}/order"
      - "{{BaseURL}}/shop"
      - "{{BaseURL}}/store"
      - "{{BaseURL}}/buy"
      - "{{BaseURL}}/purchase"
      - "{{BaseURL}}/billing"
      - "{{BaseURL}}/account/orders"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,*/*"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      # E-commerce cookies without HttpOnly flag
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(cart|checkout|payment|order|shop|store|buy|purchase|customer|billing|shipping|woocommerce|magento|shopify|prestashop|opencart|bigcommerce)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

      # E-commerce indicators
      - type: regex
        part: body
        regex:
          - "(?i)(cart|checkout|payment|order|shop|store|buy|purchase|price|\\$|€|£|¥)"
          - "(?i)(woocommerce|magento|shopify|prestashop|opencart|bigcommerce)"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:cart|checkout|payment|order|shop|store|buy|purchase|customer|billing|shipping|woocommerce|magento|shopify|prestashop|opencart|bigcommerce)[^;\\r\\n]*)"

  # Test for tracking and analytics cookies (should have HttpOnly for security)
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/analytics"
      - "{{BaseURL}}/tracking"
      - "{{BaseURL}}/metrics"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,*/*"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      # Tracking/Analytics cookies without HttpOnly flag (security concern)
      - type: regex
        part: header
        regex:
          - "(?i)set-cookie:\\s*[^;\\r\\n]*(analytics|tracking|metrics|stats|visitor|user_id|client_id|session_id|unique_id)[^;\\r\\n]*(?!.*httponly)[;\\r\\n]"
        condition: or

      # Contains JavaScript tracking code
      - type: regex
        part: body
        regex:
          - "(?i)(google-analytics|gtag|ga\\(|_gaq|analytics\\.js|gtm\\.js)"
          - "(?i)(facebook\\.com/tr|fbq\\(|_fbp|_fbc)"
          - "(?i)(document\\.cookie|localStorage|sessionStorage)"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)set-cookie:\\s*([^;\\r\\n]*(?:analytics|tracking|metrics|stats|visitor|user_id|client_id|session_id|unique_id)[^;\\r\\n]*)"