id: medium-cors-credentials-true-wildcard

info:
  name: CORS Credentials True with Wildcard Attack - Elite
  author: redteam-elite
  severity: high
  description: |
    Detects critical CORS misconfiguration where server allows wildcard (*) origin with credentials=true.
    This is extremely dangerous as it allows any domain to access sensitive data with user credentials.
    Elite template with advanced credential extraction techniques and multiple exploitation vectors.
  reference:
    - https://portswigger.net/web-security/cors/lab-global-origin-null-attack
    - https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N
    cvss-score: 8.1
    cwe-id: CWE-346
  metadata:
    verified: true
    max-request: 5
  tags: cors,misconfiguration,credentials,wildcard,critical,elite,redteam

http:
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/admin"
      - "{{BaseURL}}/dashboard"

    headers:
      Origin: "https://evil-attacker.com"
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"
        condition: and

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"
        condition: and

      - type: status
        status:
          - 200
          - 201
          - 202

    extractors:
      - type: kval
        kval:
          - access_control_allow_origin
          - access_control_allow_credentials
          - access_control_allow_methods
        part: header

  - method: OPTIONS
    path:
      - "{{BaseURL}}/api/sensitive"
      - "{{BaseURL}}/user/profile"
      - "{{BaseURL}}/admin/users"

    headers:
      Origin: "https://malicious-domain.evil"
      Access-Control-Request-Method: "GET"
      Access-Control-Request-Headers: "Authorization,X-API-Key,Cookie"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Methods"

      - type: status
        status:
          - 200
          - 204

  - method: GET
    path:
      - "{{BaseURL}}/api/user/data"
      - "{{BaseURL}}/api/user/profile"
      - "{{BaseURL}}/api/user/settings"

    headers:
      Origin: "https://attacker-controlled.com"
      Cookie: "session=valid_session; auth_token=valid_token; user_id=1"
      Authorization: "Bearer valid-jwt-token"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: word
        part: body
        words:
          - "user"
          - "profile"
          - "email"
          - "data"
          - "settings"
          - "personal"
        condition: or

      - type: status
        status:
          - 200

  - method: POST
    path:
      - "{{BaseURL}}/api/admin/action"
      - "{{BaseURL}}/api/sensitive/extract"
      - "{{BaseURL}}/api/user/update"

    headers:
      Origin: "https://credential-stealer.evil"
      Content-Type: "application/json"
      Cookie: "admin_session=valid; csrf_token=bypass"
      X-Requested-With: "XMLHttpRequest"

    body: |
      {"action":"extract_all_data","include_credentials":true,"target":"all_users"}

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: word
        part: body
        words:
          - "success"
          - "extracted"
          - "admin"
          - "users"
          - "data"
          - "credentials"
        condition: or

      - type: status
        status:
          - 200

  - method: GET
    path:
      - "{{BaseURL}}/api/admin/secrets"
      - "{{BaseURL}}/api/config/keys"
      - "{{BaseURL}}/internal/credentials"

    headers:
      Origin: "https://data-exfiltration.hacker"
      Cookie: "admin=true; role=superuser; access_level=max"
      Authorization: "Bearer admin-token"
      X-Admin-Key: "bypass-key"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: word
        part: body
        words:
          - "secret"
          - "key"
          - "token"
          - "password"
          - "credential"
          - "api_key"
          - "admin"
        condition: or

      - type: status
        status:
          - 200

# Critical CORS misconfiguration - wildcard with credentials allows complete data exfiltration