id: cors-wildcard-credentials-true-elite

info:
  name: CORS Wildcard with Credentials True - Elite Detection
  author: redteam-elite
  severity: medium
  description: |
    Detects dangerous CORS (Cross-Origin Resource Sharing) configurations where Access-Control-Allow-Origin
    is set to wildcard (*) while Access-Control-Allow-Credentials is set to true. This elite template
    uses advanced red team techniques to identify this critical security misconfiguration that allows
    any origin to make credentialed requests, potentially leading to data theft and CSRF attacks.
  reference:
    - https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
    - https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny
    - https://portswigger.net/web-security/cors
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N
    cvss-score: 8.1
    cwe-id: CWE-346
  metadata:
    verified: true
    max-request: 15
    shodan-query: "Access-Control-Allow-Origin: *"
  tags: cors,misconfiguration,credentials,wildcard,csrf,security-headers

http:
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/"
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/api/"
      - "{{BaseURL}}/api/v1"
      - "{{BaseURL}}/api/v2"
      - "{{BaseURL}}/rest"
      - "{{BaseURL}}/rest/"
      - "{{BaseURL}}/graphql"
      - "{{BaseURL}}/admin"
      - "{{BaseURL}}/login"
      - "{{BaseURL}}/user"
      - "{{BaseURL}}/profile"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://evil.com"
      Accept: "application/json,text/html,*/*"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"
        condition: and

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"
        condition: and

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

    extractors:
      - type: kval
        kval:
          - access_control_allow_origin
          - access_control_allow_credentials
          - access_control_allow_methods
          - access_control_allow_headers

# Advanced detection with different origins
  - method: GET
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/api/users"
      - "{{BaseURL}}/api/data"
      - "{{BaseURL}}/rest/users"
      - "{{BaseURL}}/graphql"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://attacker.evil.com"
      Accept: "application/json"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

# Test with OPTIONS preflight request
  - method: OPTIONS
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/api/v1"
      - "{{BaseURL}}/rest"
      - "{{BaseURL}}/graphql"
      - "{{BaseURL}}/admin/api"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://malicious-site.com"
      Access-Control-Request-Method: "POST"
      Access-Control-Request-Headers: "Content-Type, Authorization"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 204

# Test with POST request to trigger CORS
  - method: POST
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/api/login"
      - "{{BaseURL}}/api/user"
      - "{{BaseURL}}/rest/auth"
      - "{{BaseURL}}/graphql"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://hacker.com"
      Content-Type: "application/json"

    body: '{"test": "data"}'

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 400
          - 401
          - 403

# Test with different malicious origins
  - method: GET
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/admin"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "null"
      Accept: "application/json"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

# Test with file:// origin
  - method: GET
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/rest"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "file://"
      Accept: "application/json"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

# Test with data: origin
  - method: GET
    path:
      - "{{BaseURL}}/api"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "data:text/html,<script>alert(1)</script>"
      Accept: "application/json"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

# Test common API endpoints
  - method: GET
    path:
      - "{{BaseURL}}/api/v1/users"
      - "{{BaseURL}}/api/v2/users"
      - "{{BaseURL}}/api/auth"
      - "{{BaseURL}}/api/profile"
      - "{{BaseURL}}/api/settings"
      - "{{BaseURL}}/rest/users"
      - "{{BaseURL}}/rest/auth"
      - "{{BaseURL}}/graphql/query"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://evil-cors-test.com"
      Accept: "application/json"
      Authorization: "Bearer test-token"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204
          - 401
          - 403

# Test with XMLHttpRequest headers
  - method: GET
    path:
      - "{{BaseURL}}/api"
      - "{{BaseURL}}/admin/api"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://cors-exploit.com"
      X-Requested-With: "XMLHttpRequest"
      Accept: "application/json"

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 204

# Test with fetch API simulation
  - method: POST
    path:
      - "{{BaseURL}}/api/data"
      - "{{BaseURL}}/api/submit"

    headers:
      User-Agent: "Mozilla/5.0 (compatible; SecurityScanner/1.0)"
      Origin: "https://malicious-cors.com"
      Content-Type: "application/json"
      Accept: "application/json"

    body: '{"action": "test", "data": "cors-test"}'

    matchers-condition: and
    matchers:
      - type: word
        part: header
        words:
          - "Access-Control-Allow-Origin: *"

      - type: word
        part: header
        words:
          - "Access-Control-Allow-Credentials: true"

      - type: status
        status:
          - 200
          - 201
          - 202
          - 400
          - 401
          - 403