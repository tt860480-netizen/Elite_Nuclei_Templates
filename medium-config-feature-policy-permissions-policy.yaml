id: medium-config-feature-policy-permissions-policy

info:
  name: Feature Policy / Permissions Policy Missing Detection
  author: elite-red-team
  severity: medium
  description: |
    Detects missing Feature-Policy or Permissions-Policy headers that control browser features.
    This elite template identifies web applications that don't restrict dangerous browser APIs
    like camera, microphone, geolocation, and payment which can be exploited by attackers.
  reference:
    - https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Feature-Policy
    - https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy
    - https://owasp.org/www-project-secure-headers/#permissions-policy
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N
    cvss-score: 5.4
    cwe-id: CWE-16
  metadata:
    verified: true
    max-request: 3
  tags: config,feature-policy,permissions-policy,headers,browser-security,medium

http:
  # Test main application pages
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/login"
      - "{{BaseURL}}/dashboard"
      - "{{BaseURL}}/profile"
      - "{{BaseURL}}/settings"
      - "{{BaseURL}}/admin"
      - "{{BaseURL}}/app"
      - "{{BaseURL}}/panel"
      - "{{BaseURL}}/console"
      - "{{BaseURL}}/management"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      Accept-Language: "en-US,en;q=0.5"
      Connection: "keep-alive"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201
          - 202

      - type: word
        part: header
        words:
          - "text/html"
        condition: or

      # Check for missing both Feature-Policy and Permissions-Policy
      - type: word
        part: header
        words:
          - "feature-policy"
          - "Feature-Policy"
          - "FEATURE-POLICY"
          - "permissions-policy"
          - "Permissions-Policy"
          - "PERMISSIONS-POLICY"
        negative: true

      # Ensure it's an interactive web application
      - type: regex
        part: body
        regex:
          - "(?i)<(form|input|button|select|textarea)"
          - "(?i)(login|signin|signup|register|dashboard|profile|settings|admin)"
          - "(?i)<script[^>]*>"
        condition: or

      # Check for potential dangerous API usage in JavaScript
      - type: regex
        part: body
        regex:
          - "(?i)(navigator\\.(geolocation|camera|microphone|getUserMedia))"
          - "(?i)(payment|webauthn|bluetooth|usb|serial)"
          - "(?i)(accelerometer|gyroscope|magnetometer)"
        condition: or

    extractors:
      - type: kval
        kval:
          - feature_policy
          - permissions_policy
          - content_security_policy
          - server
        part: header

      - type: regex
        part: body
        group: 1
        regex:
          - '(?i)navigator\\.(geolocation|getUserMedia|camera|microphone)'
          - '(?i)(payment|webauthn|bluetooth|usb|serial)'

  # Test pages that commonly use sensitive APIs
  - method: GET
    path:
      - "{{BaseURL}}/upload"
      - "{{BaseURL}}/camera"
      - "{{BaseURL}}/video"
      - "{{BaseURL}}/audio"
      - "{{BaseURL}}/location"
      - "{{BaseURL}}/map"
      - "{{BaseURL}}/payment"
      - "{{BaseURL}}/checkout"
      - "{{BaseURL}}/webrtc"
      - "{{BaseURL}}/media"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 404

      # Missing policy headers
      - type: word
        part: header
        words:
          - "feature-policy"
          - "permissions-policy"
        negative: true

      # Contains sensitive API calls or references
      - type: regex
        part: body
        regex:
          - "(?i)(getUserMedia|getDisplayMedia|enumerateDevices)"
          - "(?i)(geolocation|getCurrentPosition|watchPosition)"
          - "(?i)(PaymentRequest|PaymentMethodChangeEvent)"
          - "(?i)(navigator\\.(camera|microphone|bluetooth|usb))"
          - "(?i)(accelerometer|gyroscope|magnetometer|ambient-light)"
        condition: or

    extractors:
      - type: regex
        part: body
        group: 1
        regex:
          - '(?i)(getUserMedia|getDisplayMedia|geolocation|PaymentRequest|navigator\\.[a-zA-Z]+)'

  # Advanced test with iframe detection
  - method: GET
    path:
      - "{{BaseURL}}"
      - "{{BaseURL}}/embed"
      - "{{BaseURL}}/widget"
      - "{{BaseURL}}/frame"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      # No permissions policy
      - type: word
        part: header
        words:
          - "permissions-policy"
          - "feature-policy"
        negative: true

      # Contains iframes or embeddable content
      - type: regex
        part: body
        regex:
          - "(?i)<iframe[^>]*>"
          - "(?i)<embed[^>]*>"
          - "(?i)<object[^>]*>"
          - '(?i)allow=["\']([^"\']*)(camera|microphone|geolocation|payment|fullscreen)[^"\']*["\']'
        condition: or

      # Check for dangerous iframe permissions
      - type: regex
        part: body
        regex:
          - '(?i)<iframe[^>]*allow=["\'][^"\']*'
        condition: or

    extractors:
      - type: regex
        part: body
        group: 1
        regex:
          - '(?i)<iframe[^>]*allow=["\']([^"\']+)["\']'
          - '(?i)<iframe[^>]*src=["\']([^"\']+)["\']'

  # Test for weak or permissive policies
  - method: GET
    path:
      - "{{BaseURL}}"

    headers:
      User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      Accept: "text/html,application/xhtml+xml"

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      # Detect overly permissive policies
      - type: regex
        part: header
        regex:
          - "(?i)(feature-policy|permissions-policy):[^\\r\\n]*\\*"
          - "(?i)(feature-policy|permissions-policy):[^\\r\\n]*(camera|microphone|geolocation)\\s*\\*"
          - "(?i)(feature-policy|permissions-policy):[^\\r\\n]*'self'\\s+\\*"
        condition: or

      # Check for interactive content
      - type: word
        part: body
        words:
          - "<form"
          - "<input"
          - "<script"
        condition: or

    extractors:
      - type: regex
        part: header
        group: 1
        regex:
          - "(?i)(feature-policy|permissions-policy):\\s*([^\\r\\n]+)"